{"version":3,"sources":["../src/socket.ts"],"names":["path","createServer","v4","uuidv4","os","tmpPath","tmpdir","Socket","name","commands","server","chunks","resolve","commandName","data","command","result","Array","isArray","chunk","client","id","match","push","slice","length","parseChunks","err","Error","write","JSON","stringify","message","Promise","all","Object","entries","map","handleCommand","results","reduce","resultsKeys","keys","join","toString","parse","close","process","on","handleCleanup","bind","reject","socket","setEncoding","handleData","listen","removeListener"],"mappings":"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","sourcesContent":["/**\n * Copyright 2021 Silicon Hills LLC\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport path from 'path';\nimport { createServer, Socket as NetSocket, Server } from 'net';\nimport { v4 as uuidv4 } from 'uuid';\nimport os from 'os';\nimport { HashMap } from './types';\n\nconst tmpPath = os.tmpdir();\n\nexport default class Socket {\n  path: string;\n\n  server?: Server;\n\n  chunks: HashMap<string[]> = {};\n\n  constructor(\n    public name = 'captain_hook',\n    protected commands: HashMap<(...args: any[]) => any> = {}\n  ) {\n    this.path = path.resolve(tmpPath, `${this.name}.sock`);\n  }\n\n  async handleCommand(commandName: string, data: any) {\n    const command = this.commands[commandName];\n    let result = command;\n    if (typeof command === 'function') {\n      result = await command(...(Array.isArray(data) ? data : [data]));\n    }\n    if (typeof result === 'undefined') return null;\n    return result;\n  }\n\n  async handleData(chunk: string, client: Client) {\n    let chunks = this.chunks[client.id];\n    if (!chunks) {\n      chunks = [];\n      this.chunks[client.id] = chunks;\n    }\n    if (chunk.match(/\\r\\n$/)) {\n      chunks.push(chunk.slice(0, chunk.length - 2));\n      const data = this.parseChunks<HashMap>(chunks);\n      if (typeof data === 'string') {\n        const err = new Error(`'${data}' is invalid`);\n        client.write(\n          `${JSON.stringify({ err: { message: err.message } })}\\r\\n`\n        );\n        throw err;\n      }\n      let results = (\n        await Promise.all(\n          Object.entries(data).map<Promise<[string, any]>>(\n            async ([command, data]: [string, any]) => {\n              return [command, await this.handleCommand(command, data)];\n            }\n          )\n        )\n      ).reduce((result: HashMap, [command, data]: [string, any]) => {\n        result[command] = data;\n        return result;\n      }, {});\n      const resultsKeys = Object.keys(results);\n      if (resultsKeys.length === 1) results = results[resultsKeys[0]];\n      client.write(`${JSON.stringify(results)}\\r\\n`);\n    } else {\n      chunks.push(chunk);\n    }\n  }\n\n  parseChunks<T = any>(chunks: string | string[]): T {\n    const data = Array.isArray(chunks) ? chunks.join('') : chunks.toString();\n    try {\n      return JSON.parse(data);\n    } catch (err) {\n      return data as unknown as T;\n    }\n  }\n\n  handleCleanup() {\n    this.close();\n  }\n\n  async connect() {\n    process.on('exit', this.handleCleanup.bind(this));\n    process.on('SIGINT', this.handleCleanup.bind(this));\n    process.on('SIGUSR1', this.handleCleanup.bind(this));\n    process.on('SIGUSR2', this.handleCleanup.bind(this));\n    process.on('uncaughtException', this.handleCleanup.bind(this));\n    this.server = await new Promise<Server>((resolve, reject) => {\n      try {\n        const server = createServer((socket: NetSocket) => {\n          const client = socket as Client;\n          client.id = uuidv4();\n          client.setEncoding('utf8');\n          client.on('data', (chunk: string) => this.handleData(chunk, client));\n        });\n        server.on('listening', () => resolve(server));\n        server.listen(this.path);\n      } catch (err) {\n        reject(err);\n      }\n    });\n  }\n\n  async close() {\n    if (!this.server) return;\n    await new Promise((resolve, reject) => {\n      if (!this.server) return resolve(null);\n      try {\n        process.removeListener('exit', this.handleCleanup.bind(this));\n        process.removeListener('SIGINT', this.handleCleanup.bind(this));\n        process.removeListener('SIGUSR1', this.handleCleanup.bind(this));\n        process.removeListener('SIGUSR2', this.handleCleanup.bind(this));\n        process.removeListener(\n          'uncaughtException',\n          this.handleCleanup.bind(this)\n        );\n        return this.server.close(() => resolve(null));\n      } catch (err) {\n        return reject(err);\n      }\n    });\n  }\n}\n\nexport interface Client extends NetSocket {\n  id: string;\n}\n"],"file":"socket.js"}