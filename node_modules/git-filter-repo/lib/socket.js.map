{"version":3,"sources":["../src/socket.ts"],"names":["tmpPath","os","tmpdir","Socket","name","commands","path","server","chunks","resolve","commandName","data","command","result","Array","isArray","chunk","client","id","match","push","slice","length","parseChunks","err","Error","write","JSON","stringify","message","Promise","all","Object","entries","map","handleCommand","results","reduce","resultsKeys","keys","join","toString","parse","close","process","on","handleCleanup","bind","reject","socket","setEncoding","handleData","listen","removeListener"],"mappings":"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","sourcesContent":["/**\n * Copyright 2021 Silicon Hills LLC\n *\n * Licensed under the Apache License, Version 2.0 (the \"License\");\n * you may not use this file except in compliance with the License.\n * You may obtain a copy of the License at\n *\n * http://www.apache.org/licenses/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS,\n * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n * See the License for the specific language governing permissions and\n * limitations under the License.\n */\n\nimport path from 'path';\nimport { createServer, Socket as NetSocket, Server } from 'net';\nimport { v4 as uuidv4 } from 'uuid';\nimport os from 'os';\nimport { HashMap } from './types';\n\nconst tmpPath = os.tmpdir();\n\nexport default class Socket {\n  path: string;\n\n  server?: Server;\n\n  chunks: HashMap<string[]> = {};\n\n  constructor(\n    public name = 'captain_hook',\n    protected commands: HashMap<(...args: any[]) => any> = {}\n  ) {\n    this.path = path.resolve(tmpPath, `${this.name}.sock`);\n  }\n\n  async handleCommand(commandName: string, data: any) {\n    const command = this.commands[commandName];\n    let result = command;\n    if (typeof command === 'function') {\n      result = await command(...(Array.isArray(data) ? data : [data]));\n    }\n    if (typeof result === 'undefined') return null;\n    return result;\n  }\n\n  async handleData(chunk: string, client: Client) {\n    let chunks = this.chunks[client.id];\n    if (!chunks) {\n      chunks = [];\n      this.chunks[client.id] = chunks;\n    }\n    if (chunk.match(/\\r\\n$/)) {\n      chunks.push(chunk.slice(0, chunk.length - 2));\n      const data = this.parseChunks<HashMap>(chunks);\n      if (typeof data === 'string') {\n        const err = new Error(`'${data}' is invalid`);\n        client.write(\n          `${JSON.stringify({ err: { message: err.message } })}\\r\\n`\n        );\n        throw err;\n      }\n      let results = (\n        await Promise.all(\n          Object.entries(data).map<Promise<[string, any]>>(\n            async ([command, data]: [string, any]) => {\n              return [command, await this.handleCommand(command, data)];\n            }\n          )\n        )\n      ).reduce((result: HashMap, [command, data]: [string, any]) => {\n        result[command] = data;\n        return result;\n      }, {});\n      const resultsKeys = Object.keys(results);\n      if (resultsKeys.length === 1) results = results[resultsKeys[0]];\n      client.write(`${JSON.stringify(results)}\\r\\n`);\n    } else {\n      chunks.push(chunk);\n    }\n  }\n\n  parseChunks<T = any>(chunks: string | string[]): T {\n    const data = Array.isArray(chunks) ? chunks.join('') : chunks.toString();\n    try {\n      return JSON.parse(data);\n    } catch (err) {\n      return data as unknown as T;\n    }\n  }\n\n  handleCleanup() {\n    this.close();\n  }\n\n  async connect() {\n    process.on('exit', this.handleCleanup.bind(this));\n    process.on('SIGINT', this.handleCleanup.bind(this));\n    process.on('SIGUSR1', this.handleCleanup.bind(this));\n    process.on('SIGUSR2', this.handleCleanup.bind(this));\n    process.on('uncaughtException', this.handleCleanup.bind(this));\n    this.server = await new Promise<Server>((resolve, reject) => {\n      try {\n        const server = createServer((socket: NetSocket) => {\n          const client = socket as Client;\n          client.id = uuidv4();\n          client.setEncoding('utf8');\n          client.on('data', (chunk: string) => this.handleData(chunk, client));\n        });\n        server.on('listening', () => resolve(server));\n        server.listen(this.path);\n      } catch (err) {\n        reject(err);\n      }\n    });\n  }\n\n  async close() {\n    if (!this.server) return;\n    await new Promise((resolve, reject) => {\n      if (!this.server) return resolve(null);\n      try {\n        process.removeListener('exit', this.handleCleanup.bind(this));\n        process.removeListener('SIGINT', this.handleCleanup.bind(this));\n        process.removeListener('SIGUSR1', this.handleCleanup.bind(this));\n        process.removeListener('SIGUSR2', this.handleCleanup.bind(this));\n        process.removeListener(\n          'uncaughtException',\n          this.handleCleanup.bind(this)\n        );\n        return this.server.close(() => resolve(null));\n      } catch (err) {\n        return reject(err);\n      }\n    });\n  }\n}\n\nexport interface Client extends NetSocket {\n  id: string;\n}\n"],"file":"socket.js"}